generator client {
  provider     = "prisma-client"
  output       = "../src/generated/"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String            @id @default(cuid())
  email                String            @unique
  password             String?
  googleId             String?           @unique
  avatarUrl            String?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  address              String?
  phone                String?
  gender               String?
  name                 String?
  role                 String            @default("USER")
  isVerified               Boolean           @default(false)
  verificationToken        String?           @unique
  verificationExpires      DateTime?
  verificationRequests     Int               @default(0)
  lastVerificationRequest  DateTime?
  resetPasswordToken       String?           @unique
  resetPasswordExpires     DateTime?
  attendances          Attendance[]
  folders              Folder[]
  practiceSessions     PracticeSession[]
  studyCounts          StudyCount[]
}

model Folder {
  id               String            @id @default(cuid())
  name             String
  description      String?
  user_id          String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  isPublic         Boolean           @default(false)
  saves            Int               @default(0)
  version          Int               @default(1)
  flashcards       Flashcard[]
  user             User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  practiceSessions PracticeSession[]

  @@index([user_id])
  @@index([isPublic])
}

model Flashcard {
  id                       String                    @id @default(cuid())
  name                     String
  meaning                  String
  folder_id                String?
  review_count             Int                       @default(0)
  audio_url                String?
  usage                    Json?
  tags                     String[]
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  easeFactor               Float                     @default(2.5)
  interval                 Float                     @default(0)
  lapseCount               Int                       @default(0)
  nextReview               DateTime?
  status                   String                    @default("new")
  folder                   Folder?                   @relation(fields: [folder_id], references: [id])
  practiceSessionQuestions PracticeSessionQuestion[]

  @@index([folder_id])
  @@index([status])
  @@index([nextReview])
}

model StudyCount {
  id          String   @id @default(cuid())
  user_id     String
  newCount    Int      @default(0)
  reviewCount Int      @default(0)
  day         DateTime @db.Date
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, day], name: "user_id_day")
  @@index([user_id])
  @@index([day])
}

model Attendance {
  id        String   @id @default(cuid())
  user_id   String
  date      DateTime @db.Date
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, date], name: "user_id_date")
  @@index([user_id])
  @@index([date])
}

model PracticeSession {
  id             String                    @id @default(cuid())
  userId         String
  folderId       String
  mode           String                    @default("fill-in-the-blank")
  status         String                    @default("IN_PROGRESS")
  currentIndex   Int                       @default(0)
  correctCount   Int                       @default(0)
  incorrectCount Int                       @default(0)
  summary        String?
  startTime      DateTime                  @default(now())
  endTime        DateTime?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  folderVersion  Int                       @default(1)
  folder         Folder                    @relation(fields: [folderId], references: [id], onDelete: Cascade)
  user           User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers        PracticeSessionAnswer[]
  questions      PracticeSessionQuestion[]

  @@index([userId])
  @@index([folderId])
}

model PracticeSessionQuestion {
  id          String                  @id @default(cuid())
  sessionId   String
  flashcardId String
  question    String
  answer      String
  options     Json?
  order       Int
  answers     PracticeSessionAnswer[]
  flashcard   Flashcard               @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  session     PracticeSession         @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([flashcardId])
}

model PracticeSessionAnswer {
  id         String                  @id @default(cuid())
  sessionId  String
  questionId String
  userAnswer String
  isCorrect  Boolean
  evaluation Json?
  answeredAt DateTime                @default(now())
  question   PracticeSessionQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  session    PracticeSession         @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([questionId])
}
